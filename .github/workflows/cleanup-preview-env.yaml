name: Cleanup Preview Environment

on:
  pull_request:
    types: [closed]
    branches:
      - '*'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Extract metadata
      id: meta
      uses: ./.github/actions/extract-preview-metadata
      with:
        pr-number: ${{ github.event.pull_request.number }}
        committer-username: ${{ github.event.pull_request.user.login }}
    
    - name: Setup Kubernetes environment
      uses: ./.github/actions/setup-k8s
      with:
        kubeconfig: ${{ secrets.KUBECONFIG }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Cleanup Kubernetes resources
      run: |
        # Run cleanup using Task (assuming you have a cleanup task)
        task k8s:delete \
          APP_NAME="preview-env" \
          ENV="${{ steps.meta.outputs.preview-env-name }}" || true
        
        # Alternative: Direct kubectl cleanup if no task exists
        # kubectl --kubeconfig=infrastructure/tmp/kubeconfig delete namespace ${{ steps.meta.outputs.preview-env-name }} --ignore-not-found=true
    
    - name: Cleanup status
      run: |
        echo "ğŸ§¹ Cleanup completed!"
        echo "ğŸ” Preview Environment: ${{ steps.meta.outputs.preview-env-name }}"
        echo "ğŸ“Š PR Status: ${{ github.event.pull_request.merged && 'merged' || 'closed' }}"

    - name: Comment on PR
      uses: actions/github-script@v7
      with:
        script: |
          const cleanedAt = new Date().toISOString();
          const wasMerged = ${{ github.event.pull_request.merged }};
          const action = wasMerged ? 'merged' : 'closed';
          const emoji = wasMerged ? 'ğŸ‰' : 'ğŸ—‘ï¸';
          
          const comment = `## ${emoji} Preview Environment Cleaned Up
          
          Your preview environment has been successfully cleaned up after the PR was **${action}**.
          
          **ğŸ” Environment:** \`${{ steps.meta.outputs.preview-env-name }}\`
          **ğŸ“Š Action:** PR ${action}
          **ğŸ§¹ Cleaned up at:** ${cleanedAt}
          
          ---
          
          ${wasMerged ? 'ğŸ‰ **Congratulations on your successful merge!**' : 'ğŸ“ **Preview environment resources have been freed up.**'}
          
          <details>
          <summary>ğŸ”§ Cleanup Details</summary>
          
          - **Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - **Branch:** \`${{ github.head_ref }}\`
          - **PR Number:** #${{ github.event.pull_request.number }}
          
          </details>`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
